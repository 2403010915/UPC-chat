<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPC-Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">å†å²å¯¹è¯</div>
            <button class="close-sidebar" id="close-sidebar">&times;</button>
        </div>
        <div class="history-list" id="history-list">
            <!-- å†å²å¯¹è¯å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
        </div>
        <div class="sidebar-footer">
            <button class="new-chat-btn" id="new-chat-btn">å¼€å§‹æ–°å¯¹è¯</button>
        </div>
    </div>

    <!-- ä¾§è¾¹æ é®ç½© -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content" id="main-content">
        <button class="menu-btn" id="menu-btn" style="top: 15px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        <button class="menu-btn" id="clear-history-btn" style="top: 60px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        </button>

        <main>
            <div class="chat-container">
                <div class="chat-header">
                    <div class="status"></div>
                    <span>UPC-Chat</span>
                    <!-- æ–°å¢æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡† -->
                    <select class="model-select" id="model-select" style="float: right; margin-left: 10px; padding: 0 10px; border-radius: 18px; border: 1px solid #ddd; font-size: 13px;">
                        <option value="deepseek-ai/DeepSeek-V3">DeepSeek-V3ï¼ˆé»˜è®¤ï¼‰</option>
                        <option value="Tongyi-Zhiwen/QwenLong-L1-32B">QwenLong-L1</option>
                        <option value="Qwen/Qwen3-30B-A3B">Qwen3-30B</option>
                    </select>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <div class="message-container bot">
                        <!-- <div class="avatar bot-avatar">AI</div>
                        <div class="message bot-message">
                            ä½ å¥½ï¼æˆ‘æ˜¯UPC-Chatã€‚
                            <div class="message-time">åˆšåˆš</div>
                        </div> -->
                    </div>
                </div>
                <!-- æ–°å¢åŠŸèƒ½æŒ‰é’®åŒº -->
                

                <div class="typing-indicator" id="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <div class="chat-extra-actions" style="display: flex; gap: 12px; margin: 16px 0 8px 0; justify-content: center;">
                    <button class="senbutton" id="btn-train" title="ä¸ªæ€§åŒ–ä»£ç è®­ç»ƒ">
                        ä¸ªæ€§åŒ–ä»£ç è®­ç»ƒ
                    </button>
                    <button class="senbutton" id="btn-ide" title="åœ¨çº¿IDE">
                        åœ¨çº¿IDE
                    </button>
                    <button class="senbutton" id="file-upload-btn" title="ä¸Šä¼ æ–‡ä»¶">
                        ä»£ç åˆ†æä¼˜åŒ–
                    </button>
                    <button class="senbutton" id="btn-docs" title="åšé¢˜æ€»ç»“">
                         åšé¢˜æ€»ç»“
                    </button>
                </div>
                <div class="input-area">
                    <textarea class="message-input" id="message-input" placeholder="å‘ AI å‘é€æ¶ˆæ¯~" rows="1"></textarea>
                    <!-- æ–°å¢æ·±åº¦æ€è€ƒæŒ‰é’® -->
                    <button class="deep-think-btn" id="deep-think-btn" title="å¼€å¯/å…³é—­æ·±åº¦æ€è€ƒæ¨¡å¼">
                        æ·±åº¦æ€è€ƒ
                    </button>
                    <button class="deep-think-btn" id="voice-input-btn" title="è¯­éŸ³è¾“å…¥">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1v22M5 8v8a7 7 0 0 0 14 0V8"/><rect x="9" y="1" width="6" height="14" rx="3"/></svg>
                    </button>
                    
                    <input type="file" id="file-input" style="display: none;" accept=".txt,.py,.js,.java,.cpp,.c,.html,.css,.json,.md">
                    <button class="sendbutton-" id="send-button">
                        <svg class="send-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </main>
    </div>
    <script>
        // DOMå…ƒç´ 
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const menuBtn = document.getElementById('menu-btn');
        const closeSidebar = document.getElementById('close-sidebar');
        const mainContent = document.getElementById('main-content');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const newChatBtn = document.getElementById('new-chat-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const historyList = document.getElementById('history-list');
        const deepThinkBtn = document.getElementById('deep-think-btn');

        // åç«¯å›ºå®šçš„APIåœ°å€
        const API_URL = 'http://localhost:8148';

        // æ·±åº¦æ€è€ƒæ¨¡å¼çŠ¶æ€
        let deepThinkMode = false;

        // æ‰“å­—æœºæ•ˆæœé€Ÿåº¦ï¼ˆæ¯«ç§’/å­—ç¬¦ï¼‰
        const TYPING_SPEED = 15;

        // å½“å‰ä¼šè¯æ¶ˆæ¯åˆ—è¡¨
        let currentSession = [];
        // å½“å‰ä¼šè¯IDï¼ˆç”¨äºæ ‡è¯†æ­£åœ¨è¿›è¡Œçš„ä¼šè¯ï¼‰
        let currentSessionId = null;

        // åˆå§‹åŒ–ï¼šåŠ è½½å†å²è®°å½•
        window.addEventListener('load', () => {
            loadChatHistory();
            adjustTextareaHeight();
            // ä»localStorageæ¢å¤æ·±åº¦æ€è€ƒæ¨¡å¼çŠ¶æ€
            const savedMode = localStorage.getItem('deepThinkMode');
            if (savedMode === 'true') {
                toggleDeepThinkMode(true);
            }
            // åˆå§‹åŒ–æ¬¢è¿æ¶ˆæ¯
            if (currentSession.length === 0) {
                appendMessage('bot', 'ä½ å¥½ï¼æˆ‘æ˜¯UPC-Chatã€‚');
            }
        });

        // ä¾§è¾¹æ æ§åˆ¶
        menuBtn.addEventListener('click', () => {
            sidebar.classList.add('open');
            sidebarOverlay.classList.add('show');
            mainContent.classList.add('sidebar-open');
        });

        closeSidebar.addEventListener('click', closeSidebarMenu);
        sidebarOverlay.addEventListener('click', closeSidebarMenu);

        function closeSidebarMenu() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('show');
            mainContent.classList.remove('sidebar-open');
        }

        // åˆ‡æ¢æ·±åº¦æ€è€ƒæ¨¡å¼
        function toggleDeepThinkMode(active) {
            deepThinkMode = active;
            deepThinkBtn.classList.toggle('active', active);
            localStorage.setItem('deepThinkMode', active);
        }

        // æ·±åº¦æ€è€ƒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        deepThinkBtn.addEventListener('click', () => {
            toggleDeepThinkMode(!deepThinkMode);
        });

        // å‘é€æ¶ˆæ¯
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            // å¦‚æœæ˜¯æ–°ä¼šè¯ï¼Œåˆ›å»ºä¼šè¯ID
            if (currentSessionId === null) {
                currentSessionId = new Date().getTime();
            }

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            appendMessage('user', userMessage);
            currentSession.push({ role: 'user', content: userMessage });
            messageInput.value = '';
            adjustTextareaHeight();

            // è°ƒç”¨åç«¯API
            await sendMessageToAI(userMessage);
        }

        // å‘é€æ¶ˆæ¯åˆ°åç«¯API
        async function sendMessageToAI(userMessage) {
            showTypingIndicator(true);
            try {
                // è·å–é€‰ä¸­çš„æ¨¡å‹ï¼ˆæ–°å¢ï¼‰
                const selectedModel = document.getElementById('model-select').value;
        
                // æ„å»ºè¯·æ±‚æ•°æ®ï¼Œå¢åŠ æ¨¡å‹å‚æ•°ï¼ˆä¿®æ”¹ï¼‰
                const requestData = {
                    prompt: userMessage,
                    deep_think: deepThinkMode,
                    model: selectedModel  // ä¼ é€’é€‰ä¸­çš„æ¨¡å‹
                };

                // è°ƒç”¨ç”Ÿæˆä»£ç æ¥å£ï¼ˆåç»­ä»£ç ä¸å˜ï¼‰
                const response = await fetch(`${API_URL}/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
                }

                const data = await response.json();
                
                // å¤„ç†æ·±åº¦æ€è€ƒå†…å®¹ï¼Œå»é™¤æ— æ„ä¹‰ç¬¦å·
                const processedThought = data.thought_process 
                    ? data.thought_process
                        .replace(/###/g, '')  // ç§»é™¤ä¸‰çº§æ ‡é¢˜ç¬¦å·
                        .replace(/\*\*/g, '') // ç§»é™¤åŠ ç²—ç¬¦å·
                        .replace(/^\s+|\s+$/g, '') // ç§»é™¤é¦–å°¾ç©ºç™½
                    : '';
                
                // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
                const messageContainer = createBotMessageContainer();
                
                if (deepThinkMode && processedThought) {
                    // æ·±åº¦æ€è€ƒæ¨¡å¼ï¼šå›ºå®šåˆ†ä¸ºä¸¤ä¸ªåŒºåŸŸï¼Œå„å¸¦ç»¿è‰²åŠ ç²—æ ‡é¢˜
                    const combinedContent = '<div class="thinking-container"><div class="thought-process"><span class="section-title">æ·±åº¦æ€è€ƒ</span>' + processedThought + '</div><div class="separator-line"></div><div class="answer-content"><span class="section-title">å›ç­”</span>' + (data.code || 'æœªç”Ÿæˆæœ‰æ•ˆå†…å®¹') + '</div></div>';
                    
                    // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºå†…å®¹
                    await typeMessage(messageContainer, combinedContent);
                    
                    // ä¿å­˜å¯¹è¯å†å²ï¼ˆä¿å­˜å®Œæ•´å†…å®¹ï¼‰
                    currentSession.push({ role: 'bot', content: combinedContent });
                } else {
                    // æ™®é€šæ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºä»£ç 
                    const codeContent = data.code || 'æœªç”Ÿæˆæœ‰æ•ˆä»£ç ';
                    
                    // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºå†…å®¹
                    await typeMessage(messageContainer, codeContent);
                    
                    // ä¿å­˜å¯¹è¯å†å²
                    currentSession.push({ role: 'bot', content: codeContent });
                }

            } catch (error) {
                console.error('APIè¯·æ±‚é”™è¯¯:', error);
                appendMessage('bot', `ç”Ÿæˆå¤±è´¥: ${error.message}`);
                currentSession.push({ role: 'bot', content: `ç”Ÿæˆå¤±è´¥: ${error.message}` });
            } finally {
                showTypingIndicator(false);
                saveChatHistory(); // æ¯è½®å¯¹è¯åè‡ªåŠ¨ä¿å­˜
            }
        }

        // æ˜¾ç¤º/éšè—æ­£åœ¨è¾“å…¥çŠ¶æ€
        function showTypingIndicator(show) {
            typingIndicator.style.display = show ? 'block' : 'none';
        }

        // åˆ›å»ºæœºå™¨äººæ¶ˆæ¯å®¹å™¨
        function createBotMessageContainer() {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container bot';

            const avatar = document.createElement('div');
            avatar.className = 'avatar bot-avatar';
            avatar.textContent = 'AI';

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';

            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString();

            messageDiv.appendChild(messageTime);
            messageContainer.appendChild(avatar);
            messageContainer.appendChild(messageDiv);
            chatMessages.appendChild(messageContainer);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // è¿”å›å†…å®¹å°†è¢«å¡«å……çš„å…ƒç´ 
            return messageDiv;
        }

        // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºæ¶ˆæ¯
        async function typeMessage(container, content) {
            // æ¸…ç©ºå®¹å™¨ï¼ˆåªä¿ç•™æ—¶é—´æˆ³ï¼‰
            const messageTime = container.querySelector('.message-time');
            container.innerHTML = '';
            container.appendChild(messageTime);
            
            // åˆ›å»ºå†…å®¹å…ƒç´ 
            const contentElement = document.createElement('div');
            contentElement.style.whiteSpace = 'pre-wrap';
            contentElement.style.margin = '0';
            container.insertBefore(contentElement, messageTime);
            
            // é€ä¸ªå­—ç¬¦æ˜¾ç¤º
            let displayText = '';
            for (let i = 0; i < content.length; i++) {
                displayText += content[i];
                contentElement.innerHTML = displayText; // ä¸è½¬ä¹‰HTMLï¼Œä¿ç•™æ ‡ç­¾
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´
                await new Promise(resolve => setTimeout(resolve, TYPING_SPEED));
            }
        }

        // ç›´æ¥æ·»åŠ æ¶ˆæ¯ï¼ˆç”¨äºéæ‰“å­—æœºæ•ˆæœçš„æƒ…å†µï¼‰
        function appendMessage(sender, content) {
            const messageContainer = document.createElement('div');
            messageContainer.className = `message-container ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = `avatar ${sender}-avatar`;
            avatar.textContent = sender === 'user' ? 'ä½ ' : 'AI';

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            // ä¸è½¬ä¹‰HTMLï¼Œä¿ç•™æ ‡ç­¾ç»“æ„
            messageDiv.innerHTML = `<div style="white-space: pre-wrap; margin: 0;color:black">${content}</div>`;

            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString();

            messageDiv.appendChild(messageTime);
            messageContainer.appendChild(avatar);
            messageContainer.appendChild(messageDiv);
            chatMessages.appendChild(messageContainer);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ä¿å­˜èŠå¤©å†å²åˆ°localStorage
        function saveChatHistory() {
            if (currentSession.length === 0) return;
            
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            
            // å¦‚æœå½“å‰ä¼šè¯IDå­˜åœ¨ï¼Œæ›´æ–°ç°æœ‰è®°å½•ï¼›å¦åˆ™åˆ›å»ºæ–°è®°å½•
            if (currentSessionId) {
                const existingIndex = history.findIndex(item => item.id === currentSessionId);
                if (existingIndex !== -1) {
                    // æ›´æ–°ç°æœ‰è®°å½•
                    history[existingIndex] = {
                        id: currentSessionId,
                        session: currentSession.slice(),
                        time: new Date().toLocaleString(),
                        deep_think: deepThinkMode
                    };
                } else {
                    // åˆ›å»ºæ–°è®°å½•
                    history.push({
                        id: currentSessionId,
                        session: currentSession.slice(),
                        time: new Date().toLocaleString(),
                        deep_think: deepThinkMode
                    });
                }
            } else {
                // åˆ›å»ºæ–°è®°å½•ï¼ˆä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºIDï¼‰
                const timestamp = new Date().getTime();
                history.push({
                    id: timestamp,
                    session: currentSession.slice(),
                    time: new Date().toLocaleString(),
                    deep_think: deepThinkMode
                });
            }
            
            localStorage.setItem('chatHistory', JSON.stringify(history));
            renderHistoryList();
        }

        // åŠ è½½èŠå¤©å†å²
        function loadChatHistory() {
            renderHistoryList();
        }

        // æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
        function renderHistoryList() {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<div style="color:#aaa;text-align:center;padding:1.5em 0;">æš‚æ— å†å²å¯¹è¯</div>';
                return;
            }

            // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            history.slice().reverse().forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.setAttribute('data-id', item.id);
                
                // ä¸ºå½“å‰ä¼šè¯æ·»åŠ é«˜äº®æ ‡è¯†
                const isCurrentSession = item.id === currentSessionId;
                const currentSessionMark = isCurrentSession ? '<span style="color: #007bff; font-size: 10px; margin-left: 5px;">å½“å‰</span>' : '';
                
                // ä¸ºæ·±åº¦æ€è€ƒçš„å†å²è®°å½•æ·»åŠ æ ‡è®°
                const deepThinkMark = item.deep_think ? '<span style="color: #42b983; font-size: 10px; margin-left: 5px;">æ·±åº¦æ€è€ƒ</span>' : '';
                
                // æ˜¾ç¤ºç¬¬ä¸€è½®ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ‘˜è¦
                let summary = '';
                if (item.session && item.session.length > 0) {
                    const firstUser = item.session.find(msg => msg.role === 'user');
                    if (firstUser) {
                        summary = firstUser.content.substring(0, 30) + (firstUser.content.length > 30 ? '...' : '');
                    } else {
                        // æ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ¬¢è¿è¯­æˆ–"æ–°å¯¹è¯"
                        const firstBot = item.session.find(msg => msg.role === 'bot');
                        summary = firstBot ? (firstBot.content.substring(0, 20) + (firstBot.content.length > 20 ? '...' : '')) : 'æ–°å¯¹è¯';
                    }
                }
                
                // ä¸ºå½“å‰ä¼šè¯æ·»åŠ ç‰¹æ®Šæ ·å¼
                if (isCurrentSession) {
                    historyItem.style.backgroundColor = '#f8f9fa';
                    historyItem.style.borderLeft = '3px solid #007bff';
                }
                
                historyItem.innerHTML = `
                    <div style="font-weight: 500; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;">
                        <span>${summary}${currentSessionMark}${deepThinkMark}</span>
                        <button class="delete-history-btn" style="background:#e74c3c;color:white;border:none;padding:2px 8px;border-radius:3px;font-size:12px;cursor:pointer;">åˆ é™¤</button>
                    </div>
                    <div style="font-size: 12px; color: #666;">${item.time}</div>
                `;
                
                // ç‚¹å‡»åŠ è½½å¯¹è¯
                historyItem.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-history-btn')) return;
                    loadHistoryItem(item.id);
                    closeSidebarMenu();
                });
                
                // åˆ é™¤æŒ‰é’®äº‹ä»¶
                historyItem.querySelector('.delete-history-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteHistoryItem(item.id);
                });
                
                historyList.appendChild(historyItem);
            });
        }

        // åˆ é™¤å•æ¡å†å²è®°å½•
        function deleteHistoryItem(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¯¹è¯å—ï¼Ÿ')) return;
            let history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            history = history.filter(item => item.id !== id);
            localStorage.setItem('chatHistory', JSON.stringify(history));
            // å¦‚æœå½“å‰èŠå¤©åŒºå±•ç¤ºçš„æ˜¯è¢«åˆ é™¤çš„å¯¹è¯ï¼Œåˆ™æ¸…ç©ºèŠå¤©åŒºå¹¶é‡ç½®ä¼šè¯çŠ¶æ€
            if (currentSessionId === id) {
                currentSession = [];
                currentSessionId = null;
            }
            chatMessages.innerHTML = '';
            appendMessage('bot', 'ä½ å¥½ï¼æˆ‘æ˜¯ä»£ç ç”ŸæˆåŠ©æ‰‹ã€‚è¯·è¾“å…¥ä½ çš„ä»£ç éœ€æ±‚ï¼Œæˆ‘ä¼šä¸ºä½ ç”Ÿæˆç¬¦åˆè¦æ±‚çš„ä»£ç ~');
            renderHistoryList();
        }

        // åŠ è½½æŒ‡å®šå†å²è®°å½•ï¼ˆæ— æ‰“å­—æœºæ•ˆæœï¼‰
        function loadHistoryItem(id) {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            const item = history.find(h => h.id === id);
            if (item && item.session) {
                chatMessages.innerHTML = '';
                item.session.forEach(msg => {
                    appendMessage(msg.role === 'user' ? 'user' : 'bot', msg.content);
                });
                // æ¢å¤å½“å‰ä¼šè¯å†…å®¹å’ŒIDï¼Œå…è®¸ç»§ç»­å¯¹è¯
                currentSession = item.session.slice();
                currentSessionId = item.id;
                // å¦‚æœå†å²è®°å½•ä½¿ç”¨äº†æ·±åº¦æ€è€ƒæ¨¡å¼ï¼Œè‡ªåŠ¨å¼€å¯
                if (item.deep_think) {
                    toggleDeepThinkMode(true);
                }
                renderHistoryList(); // é‡æ–°æ¸²æŸ“é«˜äº®
            }
        }

        // æ–°å»ºå¯¹è¯
        newChatBtn.addEventListener('click', () => {
            saveChatHistory(); // ä¿å­˜å½“å‰ä¼šè¯
            // æ–°å»ºä¸€ä¸ªåªåŒ…å«æ¬¢è¿è¯­çš„ä¼šè¯
            currentSession = [
                { role: 'bot', content: 'ä½ å¥½ï¼æˆ‘æ˜¯UPC-Chatã€‚' }
            ];
            currentSessionId = new Date().getTime(); // æ–°ä¼šè¯ID
            chatMessages.innerHTML = '';
            appendMessage('bot', currentSession[0].content);
            saveChatHistory(); // ç«‹å³ä¿å­˜æ–°ä¼šè¯ï¼ˆè¿™æ ·å†å²æ ä¼šå‡ºç°æ–°å¯¹è¯ï¼‰
        });

        // æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•
        clearHistoryBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('chatHistory');
                historyList.innerHTML = '';
            }
        });

        // è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
        messageInput.addEventListener('input', adjustTextareaHeight);

        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            const maxHeight = 100;
            const scrollHeight = messageInput.scrollHeight;
            messageInput.style.height = `${Math.min(scrollHeight, maxHeight)}px`;
        }

        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', () => {
            saveChatHistory();
        });

        // æ–°å¢åŠŸèƒ½æŒ‰é’®äº‹ä»¶
        document.getElementById('btn-train').onclick = async function() {
            // è‡ªåŠ¨å‘AIå‘é€ä¸ªæ€§åŒ–æ¨èè¯·æ±‚ï¼ˆä¸æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼‰
            const autoMsg = 'è¯·æ ¹æ®æˆ‘çš„å†å²å¯¹è¯ï¼Œæ¨èä¸€ä»½é€‚åˆæˆ‘çš„ä»£ç é¢˜ç›®åŠé¢˜ç›®é“¾æ¥ï¼Œå°†é¢˜ç›®åˆ†ä¸ºå…¥é—¨è¿›é˜¶ç­‰éš¾åº¦';
            // ä¸æ˜¾ç¤ºappendMessageï¼Œä¸pushåˆ°currentSession
            messageInput.value = '';
            adjustTextareaHeight();
            // è°ƒç”¨åç«¯APIï¼Œæ¨¡æ‹Ÿä¸ºç³»ç»Ÿæ¶ˆæ¯
            await sendMessageToAI(autoMsg);
        };
        document.getElementById('btn-ide').onclick = function() {
            window.open('https://www.techiedelight.com/compiler/zh/index', '_blank');
        };
        document.getElementById('btn-docs').onclick = function() {
            showStudySummary();
        };

        // åšé¢˜æ€»ç»“åŠŸèƒ½
        function showStudySummary() {
            const today = new Date().toLocaleDateString();
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            
            // ç»Ÿè®¡ä»Šå¤©çš„å¯¹è¯
            const todaySessions = history.filter(item => {
                const sessionDate = new Date(item.time).toLocaleDateString();
                return sessionDate === today;
            });
            
            // ç»Ÿè®¡åšé¢˜ç›¸å…³çš„å†…å®¹
            let problemCount = 0;
            let studyTopics = [];
            
            todaySessions.forEach(session => {
                if (session.session) {
                    session.session.forEach(msg => {
                        if (msg.role === 'user') {
                            const content = msg.content.toLowerCase();
                            // æ£€æµ‹åšé¢˜ç›¸å…³çš„å…³é”®è¯
                            if (content.includes('é¢˜') || content.includes('ç®—æ³•') || content.includes('leetcode') || 
                                content.includes('æ´›è°·') || content.includes('å·²åšé¢˜') || content.includes('oj') ||
                                content.includes('ç¼–ç¨‹') || content.includes('ä»£ç ') || content.includes('å®ç°')) {
                                problemCount++;
                                // æå–é¢˜ç›®ç›¸å…³çš„å†…å®¹ä½œä¸ºå­¦ä¹ ä¸»é¢˜
                                const topic = msg.content.substring(0, 50) + (msg.content.length > 50 ? '...' : '');
                                if (!studyTopics.includes(topic)) {
                                    studyTopics.push(topic);
                                }
                            }
                        }
                    });
                }
            });
            
            // åˆ›å»ºæ€»ç»“å†…å®¹
            let summaryContent = `ğŸ“Š ä»Šæ—¥åšé¢˜æ€»ç»“ (${today})\n\n`;
            summaryContent += `ğŸ¯ åšé¢˜æ•°é‡: ${problemCount} é¢˜\n`;
            summaryContent += `ğŸ“ å­¦ä¹ ä¸»é¢˜: ${studyTopics.length} ä¸ª\n\n`;
            
            if (studyTopics.length > 0) {
                summaryContent += `ğŸ“š ä»Šæ—¥å­¦ä¹ å†…å®¹:\n`;
                studyTopics.forEach((topic, index) => {
                    summaryContent += `${index + 1}. ${topic}\n`;
                });
            } else {
                summaryContent += `ğŸ“š ä»Šæ—¥æš‚æ— åšé¢˜è®°å½•ï¼Œç»§ç»­åŠ æ²¹ï¼\n`;
            }
            
            summaryContent += `\nğŸ’¡ å»ºè®®: ä¿æŒæ¯æ—¥ç»ƒä¹ ï¼Œå¾ªåºæ¸è¿›æå‡ç®—æ³•èƒ½åŠ›ï¼`;
            
            // æ˜¾ç¤ºæ€»ç»“
            appendMessage('bot', summaryContent);
        }

        // è¯­éŸ³è¾“å…¥åŠŸèƒ½
        const voiceInputBtn = document.getElementById('voice-input-btn');
        if (voiceInputBtn) {
            let recognition;
            let recognizing = false;
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = function() {
                    recognizing = true;
                    voiceInputBtn.classList.add('active');
                    voiceInputBtn.title = 'æ­£åœ¨è†å¬...';
                };
                recognition.onend = function() {
                    recognizing = false;
                    voiceInputBtn.classList.remove('active');
                    voiceInputBtn.title = 'è¯­éŸ³è¾“å…¥';
                };
                recognition.onerror = function(event) {
                    recognizing = false;
                    voiceInputBtn.classList.remove('active');
                    voiceInputBtn.title = 'è¯­éŸ³è¾“å…¥';
                    alert('è¯­éŸ³è¯†åˆ«å‡ºé”™: ' + event.error);
                };
                recognition.onresult = function(event) {
                    if (event.results.length > 0) {
                        const transcript = event.results[0][0].transcript;
                        messageInput.value = transcript;
                        adjustTextareaHeight();
                    }
                };

                voiceInputBtn.onclick = function() {
                    if (recognizing) {
                        recognition.stop();
                    } else {
                        recognition.start();
                    }
                };
            } else {
                voiceInputBtn.onclick = function() {
                    alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
                };
            }
        }

        // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        const fileUploadBtn = document.getElementById('file-upload-btn');
        const fileInput = document.getElementById('file-input');
        
        if (fileUploadBtn && fileInput) {
            fileUploadBtn.onclick = function() {
                fileInput.click();
            };
            
            fileInput.onchange = async function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
                if (file.size > 5 * 1024 * 1024) {
                    alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                    return;
                }
                
                try {
                    const fileContent = await readFileAsText(file);
                    const fileName = file.name;
                    const fileExtension = fileName.split('.').pop().toLowerCase();
                    
                    // æ„å»ºå‘é€ç»™AIçš„æ¶ˆæ¯ï¼ˆåŒ…å«æ–‡ä»¶å†…å®¹ä½†ä¸æ˜¾ç¤ºï¼‰
                    const fileMessage = `æˆ‘ä¸Šä¼ äº†ä¸€ä¸ªæ–‡ä»¶ï¼š${fileName}\n\næ–‡ä»¶å†…å®¹ï¼š\n\`\`\`${fileExtension}\n${fileContent}\n\`\`\`\n\nè¯·å¸®æˆ‘åˆ†æè¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶æä¾›ç›¸å…³å»ºè®®æˆ–æ”¹è¿›æ–¹æ¡ˆã€‚`;
                    
                    // ç›´æ¥è°ƒç”¨AIè€Œä¸æ˜¾ç¤ºåœ¨å¯¹è¯æ¡†ä¸­
                    await sendMessageToAI(fileMessage);
                    
                } catch (error) {
                    alert('æ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message);
                }
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                fileInput.value = '';
            };
        }
        
        // è¯»å–æ–‡ä»¶ä¸ºæ–‡æœ¬
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = function(e) {
                    reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                };
                reader.readAsText(file);
            });
        }
    </script>
</body>
</html>

