<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPC-Chat</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 24px;
        }

        /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4b6ce2 0%, #56a8ff 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* å›¾è¡¨æ ·å¼ */
        .chart-container {
            margin-bottom: 24px;
        }

        .chart-container h3 {
            margin-bottom: 16px;
            color: #333;
            font-size: 18px;
        }

        .chart {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 330px;
            padding: 0 0;
            overflow: hidden;
        }

        .chart svg {
            max-width: 100%;
            height: auto;
        }

        /* æ¯æ—¥è¯¦æƒ…æ ·å¼ */
        .daily-details h3 {
            margin-bottom: 16px;
            color: #333;
            font-size: 18px;
        }

        .daily-list {
            display: grid;
            gap: 8px;
        }

        .daily-item {
            display: flex;
            flex-direction: column;
            padding: 12px 16px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #ddd;
            transition: all 0.2s;
            gap: 8px;
        }

        .daily-header {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .daily-item.active {
            background: linear-gradient(135deg, #c5e0ff 0%, #c5e0ff 100%);
            border-left-color: #004fa3;
        }

        .daily-item.inactive {
            background: #f5f5f5;
            border-left-color: #ddd;
            opacity: 0.7;
        }

        .day-name {
            font-weight: 600;
            color: #333;
            min-width: 40px;
        }

        .day-date {
            color: #666;
            margin-left: 12px;
            flex: 1;
        }

        .day-problems {
            font-weight: 600;
            color: #333;
            margin-left: 8px;
        }

        .deep-think-badge {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
        }

        .daily-topics {
            margin-top: 4px;
            padding-left: 8px;
        }

        .topic-item {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
            line-height: 1.4;
        }

        .daily-item.active .topic-item {
            color: #333;
        }

        /* å»ºè®®æ ·å¼ */
        .suggestion {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
        }

        .suggestion h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }

        .suggestion p {
            margin: 0;
            color: #555;
            line-height: 1.5;
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart {
                height: 150px;
            }
            
            .chart svg {
                transform: scale(0.8);
                transform-origin: center;
            }
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">å†å²å¯¹è¯</div>
            <button class="close-sidebar" id="close-sidebar">&times;</button>
        </div>
        <div class="history-list" id="history-list">
            <!-- å†å²å¯¹è¯å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
        </div>
        <div class="sidebar-footer">
            <button class="new-chat-btn" id="new-chat-btn">å¼€å§‹æ–°å¯¹è¯</button>
        </div>
    </div>

    <!-- ä¾§è¾¹æ é®ç½© -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content" id="main-content">
        <button class="menu-btn" id="menu-btn" style="top: 15px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        <button class="menu-btn" id="clear-history-btn" style="top: 60px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        </button>

        <main>
            <div class="chat-container">
                <div class="chat-header">
                    <div class="status"></div>
                    <span>UPC-Chat</span>
                    <!-- æ–°å¢æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡† -->
                    <select class="model-select" id="model-select" style="float: right; margin-left: 10px; padding: 0 10px; border-radius: 18px; border: 1px solid #ddd; font-size: 13px;">
                        <option value="deepseek-ai/DeepSeek-V3">DeepSeek-V3ï¼ˆé»˜è®¤ï¼‰</option>
                        <option value="Tongyi-Zhiwen/QwenLong-L1-32B">QwenLong-L1</option>
                        <option value="Qwen/Qwen3-30B-A3B">Qwen3-30B</option>
                    </select>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <div class="message-container bot">
                        <!-- <div class="avatar bot-avatar">AI</div>
                        <div class="message bot-message">
                            ä½ å¥½ï¼æˆ‘æ˜¯UPC-Chatã€‚
                            <div class="message-time">åˆšåˆš</div>
                        </div> -->
                    </div>
                </div>
                <!-- æ–°å¢åŠŸèƒ½æŒ‰é’®åŒº -->
                

                <div class="typing-indicator" id="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <div class="chat-extra-actions" style="display: flex; gap: 12px; margin: 16px 0 8px 0; justify-content: center;">
                    <button class="senbutton" id="btn-train" title="ä¸ªæ€§åŒ–é¢˜ç›®æ¨è">
                        ä¸ªæ€§åŒ–é¢˜ç›®æ¨è
                    </button>
                    <button class="senbutton" id="btn-ide" title="åœ¨çº¿IDE">
                        åœ¨çº¿IDE
                    </button>
                    <button class="senbutton" id="btn-oj" title="åœ¨çº¿OJ">
                        ä»£ç è®­ç»ƒ
                    </button>
                    <button class="senbutton" id="file-upload-btn" title="ä¸Šä¼ æ–‡ä»¶">
                        ä»£ç åˆ†æä¼˜åŒ–
                    </button>
                    
                    <button class="senbutton" id="btn-weekly" title="æ¯å‘¨å›é¡¾">
                         æ¯å‘¨å›é¡¾
                    </button>
                    
                </div>
                <div class="input-area">
                    <textarea class="message-input" id="message-input" placeholder="å‘ AI å‘é€æ¶ˆæ¯~" rows="1"></textarea>
                    <!-- æ–°å¢æ·±åº¦æ€è€ƒæŒ‰é’® -->
                    <button class="deep-think-btn" id="deep-think-btn" title="å¼€å¯/å…³é—­æ·±åº¦æ€è€ƒæ¨¡å¼">
                        æ·±åº¦æ€è€ƒ
                    </button>
                    <button class="deep-think-btn" id="voice-input-btn" title="è¯­éŸ³è¾“å…¥">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1v22M5 8v8a7 7 0 0 0 14 0V8"/><rect x="9" y="1" width="6" height="14" rx="3"/></svg>
                    </button>
                    
                    <input type="file" id="file-input" style="display: none;" accept=".txt,.py,.js,.java,.cpp,.c,.html,.css,.json,.md">
                    <button class="sendbutton-" id="send-button">
                        <svg class="send-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // DOMå…ƒç´ 
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const menuBtn = document.getElementById('menu-btn');
        const closeSidebar = document.getElementById('close-sidebar');
        const mainContent = document.getElementById('main-content');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const newChatBtn = document.getElementById('new-chat-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const historyList = document.getElementById('history-list');
        const deepThinkBtn = document.getElementById('deep-think-btn');

        // åç«¯å›ºå®šçš„APIåœ°å€
        const API_URL = 'http://localhost:8148';

        // æ·±åº¦æ€è€ƒæ¨¡å¼çŠ¶æ€
        let deepThinkMode = false;

        // æ‰“å­—æœºæ•ˆæœé€Ÿåº¦ï¼ˆæ¯«ç§’/å­—ç¬¦ï¼‰
        const TYPING_SPEED = 15;

        // å½“å‰ä¼šè¯æ¶ˆæ¯åˆ—è¡¨
        let currentSession = [];
        // å½“å‰ä¼šè¯IDï¼ˆç”¨äºæ ‡è¯†æ­£åœ¨è¿›è¡Œçš„ä¼šè¯ï¼‰
        let currentSessionId = null;

        // åˆå§‹åŒ–ï¼šåŠ è½½å†å²è®°å½•
        window.addEventListener('load', () => {
            loadChatHistory();
            adjustTextareaHeight();
            // ä»localStorageæ¢å¤æ·±åº¦æ€è€ƒæ¨¡å¼çŠ¶æ€
            const savedMode = localStorage.getItem('deepThinkMode');
            if (savedMode === 'true') {
                toggleDeepThinkMode(true);
            }
            // åˆå§‹åŒ–æ¬¢è¿æ¶ˆæ¯
            if (currentSession.length === 0) {
                appendMessage('bot', 'ä½ å¥½ï¼æˆ‘æ˜¯UPC-Chatã€‚');
            }
        });

        // ä¾§è¾¹æ æ§åˆ¶
        menuBtn.addEventListener('click', () => {
            sidebar.classList.add('open');
            sidebarOverlay.classList.add('show');
            mainContent.classList.add('sidebar-open');
        });

        closeSidebar.addEventListener('click', closeSidebarMenu);
        sidebarOverlay.addEventListener('click', closeSidebarMenu);

        function closeSidebarMenu() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('show');
            mainContent.classList.remove('sidebar-open');
        }

        // åˆ‡æ¢æ·±åº¦æ€è€ƒæ¨¡å¼
        function toggleDeepThinkMode(active) {
            deepThinkMode = active;
            deepThinkBtn.classList.toggle('active', active);
            localStorage.setItem('deepThinkMode', active);
        }

        // æ·±åº¦æ€è€ƒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        deepThinkBtn.addEventListener('click', () => {
            toggleDeepThinkMode(!deepThinkMode);
        });

        // å‘é€æ¶ˆæ¯
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            // å¦‚æœæ˜¯æ–°ä¼šè¯ï¼Œåˆ›å»ºä¼šè¯ID
            if (currentSessionId === null) {
                currentSessionId = new Date().getTime();
            }

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            appendMessage('user', userMessage);
            currentSession.push({ role: 'user', content: userMessage });
            messageInput.value = '';
            adjustTextareaHeight();

            // è°ƒç”¨åç«¯API
            await sendMessageToAI(userMessage);
        }

        // å‘é€æ¶ˆæ¯åˆ°åç«¯API
        async function sendMessageToAI(userMessage) {
            showTypingIndicator(true);
            try {
                // è·å–é€‰ä¸­çš„æ¨¡å‹ï¼ˆæ–°å¢ï¼‰
                const selectedModel = document.getElementById('model-select').value;
        
                // æ„å»ºè¯·æ±‚æ•°æ®ï¼Œå¢åŠ æ¨¡å‹å‚æ•°ï¼ˆä¿®æ”¹ï¼‰
                const requestData = {
                    prompt: userMessage,
                    deep_think: deepThinkMode,
                    model: selectedModel  // ä¼ é€’é€‰ä¸­çš„æ¨¡å‹
                };

                // è°ƒç”¨ç”Ÿæˆä»£ç æ¥å£ï¼ˆåç»­ä»£ç ä¸å˜ï¼‰
                const response = await fetch(`${API_URL}/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
                }

                const data = await response.json();
                
                // å¤„ç†æ·±åº¦æ€è€ƒå†…å®¹ï¼Œå»é™¤æ— æ„ä¹‰ç¬¦å·
                const processedThought = data.thought_process 
                    ? data.thought_process
                        .replace(/###/g, '')  // ç§»é™¤ä¸‰çº§æ ‡é¢˜ç¬¦å·
                        .replace(/\*\*/g, '') // ç§»é™¤åŠ ç²—ç¬¦å·
                        .replace(/^\s+|\s+$/g, '') // ç§»é™¤é¦–å°¾ç©ºç™½
                    : '';
                
                // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
                const messageContainer = createBotMessageContainer();
                
                if (deepThinkMode && processedThought) {
                    // æ·±åº¦æ€è€ƒæ¨¡å¼ï¼šå›ºå®šåˆ†ä¸ºä¸¤ä¸ªåŒºåŸŸï¼Œå„å¸¦ç»¿è‰²åŠ ç²—æ ‡é¢˜
                    const combinedContent = '<div class="thinking-container"><div class="thought-process"><span class="section-title">æ·±åº¦æ€è€ƒ</span>' + processedThought + '</div><div class="separator-line"></div><div class="answer-content"><span class="section-title">å›ç­”</span>' + (data.code || 'æœªç”Ÿæˆæœ‰æ•ˆå†…å®¹') + '</div></div>';
                    
                    // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºå†…å®¹
                    await typeMessage(messageContainer, combinedContent);
                    
                    // ä¿å­˜å¯¹è¯å†å²ï¼ˆä¿å­˜å®Œæ•´å†…å®¹ï¼‰
                    currentSession.push({ role: 'bot', content: combinedContent });
                } else {
                    // æ™®é€šæ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºä»£ç 
                    const codeContent = data.code || 'æœªç”Ÿæˆæœ‰æ•ˆä»£ç ';
                    
                    // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºå†…å®¹
                    await typeMessage(messageContainer, codeContent);
                    
                    // ä¿å­˜å¯¹è¯å†å²
                    currentSession.push({ role: 'bot', content: codeContent });
                }

            } catch (error) {
                console.error('APIè¯·æ±‚é”™è¯¯:', error);
                appendMessage('bot', `ç”Ÿæˆå¤±è´¥: ${error.message}`);
                currentSession.push({ role: 'bot', content: `ç”Ÿæˆå¤±è´¥: ${error.message}` });
            } finally {
                showTypingIndicator(false);
                saveChatHistory(); // æ¯è½®å¯¹è¯åè‡ªåŠ¨ä¿å­˜
            }
        }

        // æ˜¾ç¤º/éšè—æ­£åœ¨è¾“å…¥çŠ¶æ€
        function showTypingIndicator(show) {
            typingIndicator.style.display = show ? 'block' : 'none';
        }

        // åˆ›å»ºæœºå™¨äººæ¶ˆæ¯å®¹å™¨
        function createBotMessageContainer() {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container bot';

            const avatar = document.createElement('div');
            avatar.className = 'avatar bot-avatar';
            avatar.textContent = 'AI';

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';

            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString();

            messageDiv.appendChild(messageTime);
            messageContainer.appendChild(avatar);
            messageContainer.appendChild(messageDiv);
            chatMessages.appendChild(messageContainer);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // è¿”å›å†…å®¹å°†è¢«å¡«å……çš„å…ƒç´ 
            return messageDiv;
        }

        // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºæ¶ˆæ¯
        async function typeMessage(container, content) {
            // æ¸…ç©ºå®¹å™¨ï¼ˆåªä¿ç•™æ—¶é—´æˆ³ï¼‰
            const messageTime = container.querySelector('.message-time');
            container.innerHTML = '';
            container.appendChild(messageTime);
            
            // åˆ›å»ºå†…å®¹å…ƒç´ 
            const contentElement = document.createElement('div');
            contentElement.style.whiteSpace = 'pre-wrap';
            contentElement.style.margin = '0';
            container.insertBefore(contentElement, messageTime);
            
            // é€ä¸ªå­—ç¬¦æ˜¾ç¤º
            let displayText = '';
            for (let i = 0; i < content.length; i++) {
                displayText += content[i];
                contentElement.innerHTML = displayText; // ä¸è½¬ä¹‰HTMLï¼Œä¿ç•™æ ‡ç­¾
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´
                await new Promise(resolve => setTimeout(resolve, TYPING_SPEED));
            }
        }

        // ç›´æ¥æ·»åŠ æ¶ˆæ¯ï¼ˆç”¨äºéæ‰“å­—æœºæ•ˆæœçš„æƒ…å†µï¼‰
        function appendMessage(sender, content) {
            const messageContainer = document.createElement('div');
            messageContainer.className = `message-container ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = `avatar ${sender}-avatar`;
            avatar.textContent = sender === 'user' ? 'ä½ ' : 'AI';

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            // ä¸è½¬ä¹‰HTMLï¼Œä¿ç•™æ ‡ç­¾ç»“æ„
            messageDiv.innerHTML = `<div style="white-space: pre-wrap; margin: 0;color:black">${content}</div>`;

            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString();

            messageDiv.appendChild(messageTime);
            messageContainer.appendChild(avatar);
            messageContainer.appendChild(messageDiv);
            chatMessages.appendChild(messageContainer);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ä¿å­˜èŠå¤©å†å²åˆ°localStorage
        function saveChatHistory() {
            if (currentSession.length === 0) return;
            
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            
            // å¦‚æœå½“å‰ä¼šè¯IDå­˜åœ¨ï¼Œæ›´æ–°ç°æœ‰è®°å½•ï¼›å¦åˆ™åˆ›å»ºæ–°è®°å½•
            if (currentSessionId) {
                const existingIndex = history.findIndex(item => item.id === currentSessionId);
                if (existingIndex !== -1) {
                    // æ›´æ–°ç°æœ‰è®°å½•
                    history[existingIndex] = {
                        id: currentSessionId,
                        session: currentSession.slice(),
                        time: new Date().toLocaleString(),
                        deep_think: deepThinkMode
                    };
                } else {
                    // åˆ›å»ºæ–°è®°å½•
                    history.push({
                        id: currentSessionId,
                        session: currentSession.slice(),
                        time: new Date().toLocaleString(),
                        deep_think: deepThinkMode
                    });
                }
            } else {
                // åˆ›å»ºæ–°è®°å½•ï¼ˆä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºIDï¼‰
                const timestamp = new Date().getTime();
                history.push({
                    id: timestamp,
                    session: currentSession.slice(),
                    time: new Date().toLocaleString(),
                    deep_think: deepThinkMode
                });
            }
            
            localStorage.setItem('chatHistory', JSON.stringify(history));
            renderHistoryList();
        }

        // åŠ è½½èŠå¤©å†å²
        function loadChatHistory() {
            renderHistoryList();
        }

        // æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
        function renderHistoryList() {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<div style="color:#aaa;text-align:center;padding:1.5em 0;">æš‚æ— å†å²å¯¹è¯</div>';
                return;
            }

            // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            history.slice().reverse().forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.setAttribute('data-id', item.id);
                
                // ä¸ºå½“å‰ä¼šè¯æ·»åŠ é«˜äº®æ ‡è¯†
                const isCurrentSession = item.id === currentSessionId;
                const currentSessionMark = isCurrentSession ? '<span style="color: #007bff; font-size: 10px; margin-left: 5px;">å½“å‰</span>' : '';
                
                // ä¸ºæ·±åº¦æ€è€ƒçš„å†å²è®°å½•æ·»åŠ æ ‡è®°
                const deepThinkMark = item.deep_think ? '<span style="color: #007bff; font-size: 10px; margin-left: 5px;">æ·±åº¦æ€è€ƒ</span>' : '';
                
                // æ˜¾ç¤ºç¬¬ä¸€è½®ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ‘˜è¦
                let summary = '';
                if (item.session && item.session.length > 0) {
                    const firstUser = item.session.find(msg => msg.role === 'user');
                    if (firstUser) {
                        summary = firstUser.content.substring(0, 30) + (firstUser.content.length > 30 ? '...' : '');
                    } else {
                        // æ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ¬¢è¿è¯­æˆ–"æ–°å¯¹è¯"
                        const firstBot = item.session.find(msg => msg.role === 'bot');
                        summary = firstBot ? (firstBot.content.substring(0, 20) + (firstBot.content.length > 20 ? '...' : '')) : 'æ–°å¯¹è¯';
                    }
                }
                
                // ä¸ºå½“å‰ä¼šè¯æ·»åŠ ç‰¹æ®Šæ ·å¼
                if (isCurrentSession) {
                    historyItem.style.backgroundColor = '#f8f9fa';
                    historyItem.style.borderLeft = '3px solid #007bff';
                }
                
                historyItem.innerHTML = `
                    <div style="font-weight: 500; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;">
                        <span>${summary}${currentSessionMark}${deepThinkMark}</span>
                        <button class="delete-history-btn" style="background:#e74c3c;color:white;border:none;padding:2px 8px;border-radius:3px;font-size:12px;cursor:pointer;">åˆ é™¤</button>
                    </div>
                    <div style="font-size: 12px; color: #666;">${item.time}</div>
                `;
                
                // ç‚¹å‡»åŠ è½½å¯¹è¯
                historyItem.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-history-btn')) return;
                    loadHistoryItem(item.id);
                    closeSidebarMenu();
                });
                
                // åˆ é™¤æŒ‰é’®äº‹ä»¶
                historyItem.querySelector('.delete-history-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteHistoryItem(item.id);
                });
                
                historyList.appendChild(historyItem);
            });
        }

        // åˆ é™¤å•æ¡å†å²è®°å½•
        function deleteHistoryItem(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¯¹è¯å—ï¼Ÿ')) return;
            let history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            history = history.filter(item => item.id !== id);
            localStorage.setItem('chatHistory', JSON.stringify(history));
            // å¦‚æœå½“å‰èŠå¤©åŒºå±•ç¤ºçš„æ˜¯è¢«åˆ é™¤çš„å¯¹è¯ï¼Œåˆ™æ¸…ç©ºèŠå¤©åŒºå¹¶é‡ç½®ä¼šè¯çŠ¶æ€
            if (currentSessionId === id) {
                currentSession = [];
                currentSessionId = null;
            }
            chatMessages.innerHTML = '';
            appendMessage('bot', 'ä½ å¥½ï¼æˆ‘æ˜¯ä»£ç ç”ŸæˆåŠ©æ‰‹ã€‚è¯·è¾“å…¥ä½ çš„ä»£ç éœ€æ±‚ï¼Œæˆ‘ä¼šä¸ºä½ ç”Ÿæˆç¬¦åˆè¦æ±‚çš„ä»£ç ~');
            renderHistoryList();
        }

        // åŠ è½½æŒ‡å®šå†å²è®°å½•ï¼ˆæ— æ‰“å­—æœºæ•ˆæœï¼‰
        function loadHistoryItem(id) {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            const item = history.find(h => h.id === id);
            if (item && item.session) {
                chatMessages.innerHTML = '';
                item.session.forEach(msg => {
                    appendMessage(msg.role === 'user' ? 'user' : 'bot', msg.content);
                });
                // æ¢å¤å½“å‰ä¼šè¯å†…å®¹å’ŒIDï¼Œå…è®¸ç»§ç»­å¯¹è¯
                currentSession = item.session.slice();
                currentSessionId = item.id;
                // å¦‚æœå†å²è®°å½•ä½¿ç”¨äº†æ·±åº¦æ€è€ƒæ¨¡å¼ï¼Œè‡ªåŠ¨å¼€å¯
                if (item.deep_think) {
                    toggleDeepThinkMode(true);
                }
                renderHistoryList(); // é‡æ–°æ¸²æŸ“é«˜äº®
            }
        }

        // æ–°å»ºå¯¹è¯
        newChatBtn.addEventListener('click', () => {
            saveChatHistory(); // ä¿å­˜å½“å‰ä¼šè¯
            // æ–°å»ºä¸€ä¸ªåªåŒ…å«æ¬¢è¿è¯­çš„ä¼šè¯
            currentSession = [
                { role: 'bot', content: 'ä½ å¥½ï¼æˆ‘æ˜¯UPC-Chatã€‚' }
            ];
            currentSessionId = new Date().getTime(); // æ–°ä¼šè¯ID
            chatMessages.innerHTML = '';
            appendMessage('bot', currentSession[0].content);
            saveChatHistory(); // ç«‹å³ä¿å­˜æ–°ä¼šè¯ï¼ˆè¿™æ ·å†å²æ ä¼šå‡ºç°æ–°å¯¹è¯ï¼‰
        });

        // æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•
        clearHistoryBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('chatHistory');
                historyList.innerHTML = '';
            }
        });

        // è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
        messageInput.addEventListener('input', adjustTextareaHeight);

        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            const maxHeight = 100;
            const scrollHeight = messageInput.scrollHeight;
            messageInput.style.height = `${Math.min(scrollHeight, maxHeight)}px`;
        }

        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', () => {
            saveChatHistory();
        });

        // æ–°å¢åŠŸèƒ½æŒ‰é’®äº‹ä»¶
        document.getElementById('btn-train').onclick = async function() {
            // è‡ªåŠ¨å‘AIå‘é€ä¸ªæ€§åŒ–æ¨èè¯·æ±‚ï¼ˆä¸æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼‰
            const autoMsg = 'è¯·æ ¹æ®æˆ‘çš„å†å²å¯¹è¯ï¼Œæ¨èä¸€ä»½é€‚åˆæˆ‘çš„ä»£ç é¢˜ç›®åŠé¢˜ç›®é“¾æ¥ï¼Œå°†é¢˜ç›®åˆ†ä¸ºå…¥é—¨è¿›é˜¶ç­‰éš¾åº¦';
            // ä¸æ˜¾ç¤ºappendMessageï¼Œä¸pushåˆ°currentSession
            messageInput.value = '';
            adjustTextareaHeight();
            // è°ƒç”¨åç«¯APIï¼Œæ¨¡æ‹Ÿä¸ºç³»ç»Ÿæ¶ˆæ¯
            await sendMessageToAI(autoMsg);
        };
        document.getElementById('btn-ide').onclick = function() {
            window.open('https://www.techiedelight.com/compiler/zh/index', '_blank');
        };


        // æ¯å‘¨å›é¡¾åŠŸèƒ½
        document.getElementById('btn-weekly').onclick = function() {
            showWeeklySummaryModal();
        };

        function showWeeklySummaryModal() {
            const today = new Date();
            
            // è·å–æœ€è¿‘7å¤©çš„æ•°æ®
            const dailyStats = {};
            
            // åˆå§‹åŒ–7å¤©çš„æ•°æ®ç»“æ„
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                const dateStr = date.toLocaleDateString();
                dailyStats[dateStr] = {
                    date: dateStr,
                    problems: 0,
                    topics: [],
                    deepThink: 0
                };
            }
            
            // ä»localStorageè·å–OJç³»ç»Ÿæ•°æ®
            const ojHistory = JSON.parse(localStorage.getItem('ojHistory') || '[]');
            
            // ç»Ÿè®¡æ¯å‘¨OJç³»ç»Ÿåšé¢˜æ•°æ®
            ojHistory.forEach(item => {
                const sessionDate = new Date(item.timestamp).toLocaleDateString();
                if (dailyStats[sessionDate]) {
                    dailyStats[sessionDate].problems++;
                    if (item.problem && !dailyStats[sessionDate].topics.includes(item.problem)) {
                        dailyStats[sessionDate].topics.push(item.problem);
                    }
                }
            });
            
            // ä»èŠå¤©å†å²ä¸­è·å–OJç³»ç»Ÿåšé¢˜æ•°æ®
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            history.forEach(item => {
                const sessionDate = new Date(item.time).toLocaleDateString();
                if (dailyStats[sessionDate]) {
                    if (item.session) {
                        item.session.forEach(msg => {
                            if (msg.role === 'user' && msg.content.includes('OJ ç³»ç»Ÿæäº¤ä»£ç :')) {
                                dailyStats[sessionDate].problems++;
                                const topic = msg.content.substring(msg.content.indexOf('OJ ç³»ç»Ÿæäº¤ä»£ç :') + 'OJ ç³»ç»Ÿæäº¤ä»£ç :'.length, 30) + (msg.content.length > 30 ? '...' : '');
                                if (!dailyStats[sessionDate].topics.includes(topic)) {
                                    dailyStats[sessionDate].topics.push(topic);
                                }
                            }
                        });
                    }
                    if (item.deep_think) {
                        dailyStats[sessionDate].deepThink++;
                    }
                }
            });
            
            // ç”Ÿæˆå›¾è¡¨æ•°æ®
            const chartData = Object.values(dailyStats);
            const totalProblems = chartData.reduce((sum, day) => sum + day.problems, 0);
            const totalDeepThink = chartData.reduce((sum, day) => sum + day.deepThink, 0);
            const activeDays = chartData.filter(day => day.problems > 0).length;
            
            // åˆ›å»ºå¼¹çª—
            createModal(chartData, totalProblems, totalDeepThink, activeDays);
        }

        function createModal(chartData, totalProblems, totalDeepThink, activeDays) {
            // ç§»é™¤å·²å­˜åœ¨çš„å¼¹çª—
            const existingModal = document.getElementById('weekly-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰çœŸå®æ•°æ®
            const hasRealData = totalProblems > 0;
            
            const modal = document.createElement('div');
            modal.id = 'weekly-modal';
            modal.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>ğŸ“ˆ æœ¬å‘¨å­¦ä¹ å›é¡¾</h2>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${hasRealData ? `
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-number">${totalProblems}</div>
                                        <div class="stat-label">åšé¢˜æ€»æ•°</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${activeDays}/7</div>
                                        <div class="stat-label">æ´»è·ƒå¤©æ•°</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${(totalProblems / 7).toFixed(1)}</div>
                                        <div class="stat-label">æ—¥å‡åšé¢˜</div>
                                    </div>
                                </div>
                                <div class="chart-container">
                                    <h3>ğŸ“Š æœ¬å‘¨åšé¢˜è¶‹åŠ¿</h3>
                                    <div class="chart" id="weekly-chart"></div>
                                </div>
                                <div class="daily-details">
                                    <h3>ğŸ“… æ¯æ—¥è¯¦æƒ…</h3>
                                    <div class="daily-list">
                                        ${chartData.map(day => `
                                            <div class="daily-item ${day.problems > 0 ? 'active' : 'inactive'}">
                                                <div class="daily-header">
                                                    <span class="day-name">å‘¨${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][new Date(day.date).getDay()]}</span>
                                                    <span class="day-date">${day.date}</span>
                                                    <span class="day-problems">${day.problems}é¢˜</span>
                                                </div>
                                                ${day.topics.length > 0 ? `
                                                    <div class="daily-topics">
                                                        ${day.topics.map(topic => {
                                                            // å»æ‰é¢˜å·ï¼Œåªä¿ç•™éš¾åº¦å’Œç®—æ³•ç±»å‹
                                                            const cleanTopic = topic.replace(/\(é¢˜å·\d+\)/g, '');
                                                            return `<div class="topic-item">â€¢ ${cleanTopic}</div>`;
                                                        }).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="suggestion">
                                    <h3>ğŸ’¡ å­¦ä¹ å»ºè®®</h3>
                                    <p>${getSuggestion(totalProblems, activeDays)}</p>
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 40px 20px;">
                                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“Š</div>
                                    <h3 style="color: #666; margin-bottom: 15px;">æœ¬å‘¨æš‚æ— åšé¢˜è®°å½•</h3>
                                    <p style="color: #999; line-height: 1.6;">
                                        æœ¬å‘¨è¿˜æ²¡æœ‰åœ¨ä»£ç è®­ç»ƒç³»ç»Ÿä¸­åšé¢˜çš„è®°å½•ã€‚<br>
                                        å»ºè®®æ‚¨ï¼š<br>
                                        â€¢ ç‚¹å‡»"ä»£ç è®­ç»ƒ"æŒ‰é’®å¼€å§‹åšé¢˜<br>
                                        â€¢ åœ¨å¯¹è¯æ¡†ä¸­æäº¤ä»£ç è¿›è¡Œåˆ†æ<br>
                                        â€¢ ä¿æŒæ¯æ—¥ç»ƒä¹ ï¼Œæå‡ç®—æ³•èƒ½åŠ›
                                    </p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // æ·»åŠ å…³é—­äº‹ä»¶
            modal.querySelector('.modal-close').addEventListener('click', () => {
                modal.remove();
            });

            modal.querySelector('.modal-overlay').addEventListener('click', (e) => {
                if (e.target === modal.querySelector('.modal-overlay')) {
                    modal.remove();
                }
            });

            // åªæœ‰åœ¨æœ‰çœŸå®æ•°æ®æ—¶æ‰ç”Ÿæˆå›¾è¡¨
            if (hasRealData) {
                generateChart(chartData);
            }
        }

        function generateChart(data) {
            const chartContainer = document.getElementById('weekly-chart');
            const maxProblems = calculateMaxValue(data);
            const chartHeight = 150;
            const chartWidth = 700;
            
            // åˆ›å»ºSVGæŸ±çŠ¶å›¾
            const svg = `
                <svg width="${chartWidth}" height="${chartHeight + 80}" viewBox="0 0 ${chartWidth} ${chartHeight + 80}">
                    <defs>
                        <linearGradient id="barGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:0.8" />
                        </linearGradient>
                    </defs>
                    
                    <!-- èƒŒæ™¯ç½‘æ ¼ -->
                    ${generateGrid(chartWidth, chartHeight, maxProblems)}
                    
                    <!-- æŸ±çŠ¶å›¾ -->
                    ${generateBarChart(data, chartWidth, chartHeight, maxProblems)}
                    
                    <!-- Xè½´æ ‡ç­¾ -->
                    ${generateXAxisLabels(data, chartWidth, chartHeight)}
                    
                    <!-- Yè½´æ ‡ç­¾ -->
                    ${generateYAxisLabels(chartHeight, maxProblems)}
                </svg>
            `;
            
            chartContainer.innerHTML = svg;
        }

        function generateGrid(width, height, maxProblems) {
            const gridLines = [];
            const ySteps = 5;
            
            for (let i = 0; i <= ySteps; i++) {
                const y = (height / ySteps) * i;
                const value = Math.round((maxProblems / ySteps) * i);
                
                // æ ¹æ®æ•°å€¼å¤§å°è°ƒæ•´ç½‘æ ¼çº¿é€æ˜åº¦
                const opacity = value === 0 ? 0.3 : 0.5;
                const strokeWidth = value === 0 ? 1 : 1;
                
                gridLines.push(`
                    <line x1="0" y1="${y}" x2="${width}" y2="${y}" 
                          stroke="#e0e0e0" stroke-width="${strokeWidth}" opacity="${opacity}"/>
                    <text x="-20" y="${y + 5}" font-size="12" fill="#666" text-anchor="end" font-weight="500">${value}</text>
                `);
            }
            
            return gridLines.join('');
        }

        function generateBarChart(data, width, height, maxProblems) {
            const barWidth = (width / data.length) * 0.6; // æŸ±å­å®½åº¦ä¸ºé—´è·çš„60%
            const barSpacing = width / data.length;
            
            return data.map((day, index) => {
                const x = barSpacing * index + (barSpacing - barWidth) / 2;
                const barHeight = (day.problems / maxProblems) * height;
                const y = height - barHeight;
                
                // ç»Ÿä¸€æ ‡ç­¾ä½ç½®ï¼šæ˜¾ç¤ºåœ¨æŸ±å­ä¸Šæ–¹
                let labelY, labelColor, labelSize;
                
                if (day.problems === 0) {
                    // 0é¢˜æ—¶æ˜¾ç¤ºåœ¨åº•éƒ¨
                    labelY = height + 15;
                    labelColor = "#999";
                    labelSize = "12";
                } else {
                    // æœ‰åšé¢˜æ—¶ç»Ÿä¸€æ˜¾ç¤ºåœ¨æŸ±å­ä¸Šæ–¹
                    labelY = Math.max(y - 15, 10);
                    labelColor = "#333";
                    labelSize = "14";
                }
                
                // ç»Ÿä¸€ä½¿ç”¨è“è‰²æ¸å˜
                let barColor = "url(#barGradient)";
                if (day.problems === 0) {
                    barColor = "#f0f0f0";
                }
                
                return `
                    <!-- æŸ±å­ -->
                    <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" 
                          fill="${barColor}" rx="3" ry="3" opacity="${day.problems === 0 ? '0.5' : '1'}"/>
                    
                    <!-- æ•°æ®æ ‡ç­¾ -->
                    <text x="${x + barWidth/2}" y="${labelY}" font-size="${labelSize}" fill="${labelColor}" 
                          text-anchor="middle" font-weight="bold">${day.problems}</text>
                    
                    <!-- æ·»åŠ æ‚¬åœæ•ˆæœæç¤º -->
                    <title>${day.date}: ${day.problems}é¢˜${day.problems === 0 ? ' (æ— åšé¢˜è®°å½•)' : ''}</title>
                `;
            }).join('');
        }

        function generateXAxisLabels(data, width, height) {
            const barSpacing = width / data.length;
            
            return data.map((day, index) => {
                const x = barSpacing * index + barSpacing / 2;
                const dayName = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][new Date(day.date).getDay()];
                return `<text x="${x}" y="${height + 45}" font-size="14" fill="#666" text-anchor="middle" font-weight="500">å‘¨${dayName}</text>`;
            }).join('');
        }

        function calculateMaxValue(data) {
            const actualMax = Math.max(...data.map(d => d.problems));
            
            if (actualMax === 0) {
                return 5; // å¦‚æœå…¨æ˜¯0ï¼Œæ˜¾ç¤º0-5çš„åˆ»åº¦
            } else if (actualMax <= 3) {
                return Math.max(actualMax + 1, 5); // ç¡®ä¿è‡³å°‘æœ‰5ä¸ªåˆ»åº¦
            } else if (actualMax <= 10) {
                return Math.ceil(actualMax * 1.2); // å¢åŠ 20%çš„ç©ºé—´
            } else {
                return Math.ceil(actualMax * 1.1); // å¢åŠ 10%çš„ç©ºé—´
            }
        }

        function generateYAxisLabels(height, maxProblems) {
            const labels = [];
            const ySteps = 5;
            
            for (let i = 0; i <= ySteps; i++) {
                const y = (height / ySteps) * i;
                const value = Math.round((maxProblems / ySteps) * i);
                labels.push(`<text x="-20" y="${y + 5}" font-size="12" fill="#666" text-anchor="end" font-weight="500">${value}</text>`);
            }
            
            return labels.join('');
        }

        function getSuggestion(totalProblems, activeDays) {
            if (totalProblems === 0) {
                return 'æœ¬å‘¨è¿˜æ²¡æœ‰åšé¢˜è®°å½•ï¼Œå»ºè®®ä»ç®€å•çš„ç®—æ³•é¢˜å¼€å§‹ç»ƒä¹ ï¼';
            } else if (activeDays < 3) {
                return 'å­¦ä¹ é¢‘ç‡è¾ƒä½ï¼Œå»ºè®®å¢åŠ æ¯æ—¥ç»ƒä¹ æ—¶é—´ï¼';
            } else if (totalProblems < 10) {
                return 'åšé¢˜æ•°é‡é€‚ä¸­ï¼Œå¯ä»¥å°è¯•æ›´éš¾çš„é¢˜ç›®ï¼';
            } else {
                return 'å­¦ä¹ çŠ¶æ€å¾ˆå¥½ï¼Œç»§ç»­ä¿æŒï¼';
            }
        }



        // è¯­éŸ³è¾“å…¥åŠŸèƒ½
        const voiceInputBtn = document.getElementById('voice-input-btn');
        if (voiceInputBtn) {
            let recognition;
            let recognizing = false;
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = function() {
                    recognizing = true;
                    voiceInputBtn.classList.add('active');
                    voiceInputBtn.title = 'æ­£åœ¨è†å¬...';
                };
                recognition.onend = function() {
                    recognizing = false;
                    voiceInputBtn.classList.remove('active');
                    voiceInputBtn.title = 'è¯­éŸ³è¾“å…¥';
                };
                recognition.onerror = function(event) {
                    recognizing = false;
                    voiceInputBtn.classList.remove('active');
                    voiceInputBtn.title = 'è¯­éŸ³è¾“å…¥';
                    alert('è¯­éŸ³è¯†åˆ«å‡ºé”™: ' + event.error);
                };
                recognition.onresult = function(event) {
                    if (event.results.length > 0) {
                        const transcript = event.results[0][0].transcript;
                        messageInput.value = transcript;
                        adjustTextareaHeight();
                    }
                };

                voiceInputBtn.onclick = function() {
                    if (recognizing) {
                        recognition.stop();
                    } else {
                        recognition.start();
                    }
                };
            } else {
                voiceInputBtn.onclick = function() {
                    alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
                };
            }
        }

        // ä»£ç è®­ç»ƒæŒ‰é’®åŠŸèƒ½
        const btnOj = document.getElementById('btn-oj');
        if (btnOj) {
            btnOj.onclick = function() {
                // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ä»£ç è®­ç»ƒç³»ç»Ÿ
                window.open('oj.html', '_blank');
            };
        }

        // åœ¨çº¿IDEæŒ‰é’®åŠŸèƒ½
        const btnIde = document.getElementById('btn-ide');
        if (btnIde) {
            btnIde.onclick = function() {
                // åœ¨æ–°çª—å£ä¸­æ‰“å¼€åœ¨çº¿IDEé¡µé¢
                window.open('https://replit.com/', '_blank');
            };
        }

        // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        const fileUploadBtn = document.getElementById('file-upload-btn');
        const fileInput = document.getElementById('file-input');
        
        if (fileUploadBtn && fileInput) {
            fileUploadBtn.onclick = function() {
                fileInput.click();
            };
            
            fileInput.onchange = async function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
                if (file.size > 5 * 1024 * 1024) {
                    alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                    return;
                }
                
                try {
                    const fileContent = await readFileAsText(file);
                    const fileName = file.name;
                    const fileExtension = fileName.split('.').pop().toLowerCase();
                    
                    // æ„å»ºå‘é€ç»™AIçš„æ¶ˆæ¯ï¼ˆåŒ…å«æ–‡ä»¶å†…å®¹ä½†ä¸æ˜¾ç¤ºï¼‰
                    const fileMessage = `æˆ‘ä¸Šä¼ äº†ä¸€ä¸ªæ–‡ä»¶ï¼š${fileName}\n\næ–‡ä»¶å†…å®¹ï¼š\n\`\`\`${fileExtension}\n${fileContent}\n\`\`\`\n\nè¯·å¸®æˆ‘åˆ†æè¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶æä¾›ç›¸å…³å»ºè®®æˆ–æ”¹è¿›æ–¹æ¡ˆã€‚`;
                    
                    // ç›´æ¥è°ƒç”¨AIè€Œä¸æ˜¾ç¤ºåœ¨å¯¹è¯æ¡†ä¸­
                    await sendMessageToAI(fileMessage);
                    
                } catch (error) {
                    alert('æ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message);
                }
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                fileInput.value = '';
            };
        }
        
        // è¯»å–æ–‡ä»¶ä¸ºæ–‡æœ¬
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = function(e) {
                    reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                };
                reader.readAsText(file);
            });
        }
    </script>
</body>
</html>
