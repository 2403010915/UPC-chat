<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPC-Chat</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* 弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 24px;
        }

        /* 统计卡片样式 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4b6ce2 0%, #56a8ff 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* 图表样式 */
        .chart-container {
            margin-bottom: 24px;
        }

        .chart-container h3 {
            margin-bottom: 16px;
            color: #333;
            font-size: 18px;
        }

        .chart {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 330px;
            padding: 0 0;
            overflow: hidden;
        }

        .chart svg {
            max-width: 100%;
            height: auto;
        }

        /* 每日详情样式 */
        .daily-details h3 {
            margin-bottom: 16px;
            color: #333;
            font-size: 18px;
        }

        .daily-list {
            display: grid;
            gap: 8px;
        }

        .daily-item {
            display: flex;
            flex-direction: column;
            padding: 12px 16px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #ddd;
            transition: all 0.2s;
            gap: 8px;
        }

        .daily-header {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .daily-item.active {
            background: linear-gradient(135deg, #c5e0ff 0%, #c5e0ff 100%);
            border-left-color: #004fa3;
        }

        .daily-item.inactive {
            background: #f5f5f5;
            border-left-color: #ddd;
            opacity: 0.7;
        }

        .day-name {
            font-weight: 600;
            color: #333;
            min-width: 40px;
        }

        .day-date {
            color: #666;
            margin-left: 12px;
            flex: 1;
        }

        .day-problems {
            font-weight: 600;
            color: #333;
            margin-left: 8px;
        }

        .deep-think-badge {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
        }

        .daily-topics {
            margin-top: 4px;
            padding-left: 8px;
        }

        .topic-item {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
            line-height: 1.4;
        }

        .daily-item.active .topic-item {
            color: #333;
        }

        /* 建议样式 */
        .suggestion {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
        }

        .suggestion h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }

        .suggestion p {
            margin: 0;
            color: #555;
            line-height: 1.5;
        }

        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart {
                height: 150px;
            }
            
            .chart svg {
                transform: scale(0.8);
                transform-origin: center;
            }
        }
    </style>
</head>
<body>
    <!-- 侧边栏 -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">历史对话</div>
            <button class="close-sidebar" id="close-sidebar">&times;</button>
        </div>
        <div class="history-list" id="history-list">
            <!-- 历史对话将通过JavaScript动态添加 -->
        </div>
        <div class="sidebar-footer">
            <button class="new-chat-btn" id="new-chat-btn">开始新对话</button>
        </div>
    </div>

    <!-- 侧边栏遮罩 -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- 主内容区域 -->
    <div class="main-content" id="main-content">
        <button class="menu-btn" id="menu-btn" style="top: 15px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        <button class="menu-btn" id="clear-history-btn" style="top: 60px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        </button>

        <main>
            <div class="chat-container">
                <div class="chat-header">
                    <div class="status"></div>
                    <span>UPC-Chat</span>
                    <!-- 新增模型选择下拉框 -->
                    <select class="model-select" id="model-select" style="float: right; margin-left: 10px; padding: 0 10px; border-radius: 18px; border: 1px solid #ddd; font-size: 13px;">
                        <option value="deepseek-ai/DeepSeek-V3">DeepSeek-V3（默认）</option>
                        <option value="Tongyi-Zhiwen/QwenLong-L1-32B">QwenLong-L1</option>
                        <option value="Qwen/Qwen3-30B-A3B">Qwen3-30B</option>
                    </select>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <div class="message-container bot">
                        <!-- <div class="avatar bot-avatar">AI</div>
                        <div class="message bot-message">
                            你好！我是UPC-Chat。
                            <div class="message-time">刚刚</div>
                        </div> -->
                    </div>
                </div>
                <!-- 新增功能按钮区 -->
                

                <div class="typing-indicator" id="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <div class="chat-extra-actions" style="display: flex; gap: 12px; margin: 16px 0 8px 0; justify-content: center;">
                    <button class="senbutton" id="btn-train" title="个性化题目推荐">
                        个性化题目推荐
                    </button>
                    <button class="senbutton" id="btn-ide" title="在线IDE">
                        在线IDE
                    </button>
                    <button class="senbutton" id="btn-oj" title="在线OJ">
                        代码训练
                    </button>
                    <button class="senbutton" id="file-upload-btn" title="上传文件">
                        代码分析优化
                    </button>
                    
                    <button class="senbutton" id="btn-weekly" title="每周回顾">
                         每周回顾
                    </button>
                    
                </div>
                <div class="input-area">
                    <textarea class="message-input" id="message-input" placeholder="向 AI 发送消息~" rows="1"></textarea>
                    <!-- 新增深度思考按钮 -->
                    <button class="deep-think-btn" id="deep-think-btn" title="开启/关闭深度思考模式">
                        深度思考
                    </button>
                    <button class="deep-think-btn" id="voice-input-btn" title="语音输入">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1v22M5 8v8a7 7 0 0 0 14 0V8"/><rect x="9" y="1" width="6" height="14" rx="3"/></svg>
                    </button>
                    
                    <input type="file" id="file-input" style="display: none;" accept=".txt,.py,.js,.java,.cpp,.c,.html,.css,.json,.md">
                    <button class="sendbutton-" id="send-button">
                        <svg class="send-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // DOM元素
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const menuBtn = document.getElementById('menu-btn');
        const closeSidebar = document.getElementById('close-sidebar');
        const mainContent = document.getElementById('main-content');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const newChatBtn = document.getElementById('new-chat-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const historyList = document.getElementById('history-list');
        const deepThinkBtn = document.getElementById('deep-think-btn');

        // 后端固定的API地址
        const API_URL = 'http://localhost:8148';

        // 深度思考模式状态
        let deepThinkMode = false;

        // 打字机效果速度（毫秒/字符）
        const TYPING_SPEED = 15;

        // 当前会话消息列表
        let currentSession = [];
        // 当前会话ID（用于标识正在进行的会话）
        let currentSessionId = null;

        // 初始化：加载历史记录
        window.addEventListener('load', () => {
            loadChatHistory();
            adjustTextareaHeight();
            // 从localStorage恢复深度思考模式状态
            const savedMode = localStorage.getItem('deepThinkMode');
            if (savedMode === 'true') {
                toggleDeepThinkMode(true);
            }
            // 初始化欢迎消息
            if (currentSession.length === 0) {
                appendMessage('bot', '你好！我是UPC-Chat。');
            }
        });

        // 侧边栏控制
        menuBtn.addEventListener('click', () => {
            sidebar.classList.add('open');
            sidebarOverlay.classList.add('show');
            mainContent.classList.add('sidebar-open');
        });

        closeSidebar.addEventListener('click', closeSidebarMenu);
        sidebarOverlay.addEventListener('click', closeSidebarMenu);

        function closeSidebarMenu() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('show');
            mainContent.classList.remove('sidebar-open');
        }

        // 切换深度思考模式
        function toggleDeepThinkMode(active) {
            deepThinkMode = active;
            deepThinkBtn.classList.toggle('active', active);
            localStorage.setItem('deepThinkMode', active);
        }

        // 深度思考按钮点击事件
        deepThinkBtn.addEventListener('click', () => {
            toggleDeepThinkMode(!deepThinkMode);
        });

        // 发送消息
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            // 如果是新会话，创建会话ID
            if (currentSessionId === null) {
                currentSessionId = new Date().getTime();
            }

            // 显示用户消息
            appendMessage('user', userMessage);
            currentSession.push({ role: 'user', content: userMessage });
            messageInput.value = '';
            adjustTextareaHeight();

            // 调用后端API
            await sendMessageToAI(userMessage);
        }

        // 发送消息到后端API
        async function sendMessageToAI(userMessage) {
            showTypingIndicator(true);
            try {
                // 获取选中的模型（新增）
                const selectedModel = document.getElementById('model-select').value;
        
                // 构建请求数据，增加模型参数（修改）
                const requestData = {
                    prompt: userMessage,
                    deep_think: deepThinkMode,
                    model: selectedModel  // 传递选中的模型
                };

                // 调用生成代码接口（后续代码不变）
                const response = await fetch(`${API_URL}/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`服务器错误: ${response.status}`);
                }

                const data = await response.json();
                
                // 处理深度思考内容，去除无意义符号
                const processedThought = data.thought_process 
                    ? data.thought_process
                        .replace(/###/g, '')  // 移除三级标题符号
                        .replace(/\*\*/g, '') // 移除加粗符号
                        .replace(/^\s+|\s+$/g, '') // 移除首尾空白
                    : '';
                
                // 创建消息容器
                const messageContainer = createBotMessageContainer();
                
                if (deepThinkMode && processedThought) {
                    // 深度思考模式：固定分为两个区域，各带绿色加粗标题
                    const combinedContent = '<div class="thinking-container"><div class="thought-process"><span class="section-title">深度思考</span>' + processedThought + '</div><div class="separator-line"></div><div class="answer-content"><span class="section-title">回答</span>' + (data.code || '未生成有效内容') + '</div></div>';
                    
                    // 使用打字机效果显示内容
                    await typeMessage(messageContainer, combinedContent);
                    
                    // 保存对话历史（保存完整内容）
                    currentSession.push({ role: 'bot', content: combinedContent });
                } else {
                    // 普通模式：直接显示代码
                    const codeContent = data.code || '未生成有效代码';
                    
                    // 使用打字机效果显示内容
                    await typeMessage(messageContainer, codeContent);
                    
                    // 保存对话历史
                    currentSession.push({ role: 'bot', content: codeContent });
                }

            } catch (error) {
                console.error('API请求错误:', error);
                appendMessage('bot', `生成失败: ${error.message}`);
                currentSession.push({ role: 'bot', content: `生成失败: ${error.message}` });
            } finally {
                showTypingIndicator(false);
                saveChatHistory(); // 每轮对话后自动保存
            }
        }

        // 显示/隐藏正在输入状态
        function showTypingIndicator(show) {
            typingIndicator.style.display = show ? 'block' : 'none';
        }

        // 创建机器人消息容器
        function createBotMessageContainer() {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container bot';

            const avatar = document.createElement('div');
            avatar.className = 'avatar bot-avatar';
            avatar.textContent = 'AI';

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';

            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString();

            messageDiv.appendChild(messageTime);
            messageContainer.appendChild(avatar);
            messageContainer.appendChild(messageDiv);
            chatMessages.appendChild(messageContainer);

            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // 返回内容将被填充的元素
            return messageDiv;
        }

        // 使用打字机效果显示消息
        async function typeMessage(container, content) {
            // 清空容器（只保留时间戳）
            const messageTime = container.querySelector('.message-time');
            container.innerHTML = '';
            container.appendChild(messageTime);
            
            // 创建内容元素
            const contentElement = document.createElement('div');
            contentElement.style.whiteSpace = 'pre-wrap';
            contentElement.style.margin = '0';
            container.insertBefore(contentElement, messageTime);
            
            // 逐个字符显示
            let displayText = '';
            for (let i = 0; i < content.length; i++) {
                displayText += content[i];
                contentElement.innerHTML = displayText; // 不转义HTML，保留标签
                
                // 滚动到底部
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // 等待一段时间
                await new Promise(resolve => setTimeout(resolve, TYPING_SPEED));
            }
        }

        // 直接添加消息（用于非打字机效果的情况）
        function appendMessage(sender, content) {
            const messageContainer = document.createElement('div');
            messageContainer.className = `message-container ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = `avatar ${sender}-avatar`;
            avatar.textContent = sender === 'user' ? '你' : 'AI';

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            // 不转义HTML，保留标签结构
            messageDiv.innerHTML = `<div style="white-space: pre-wrap; margin: 0;color:black">${content}</div>`;

            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString();

            messageDiv.appendChild(messageTime);
            messageContainer.appendChild(avatar);
            messageContainer.appendChild(messageDiv);
            chatMessages.appendChild(messageContainer);

            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 保存聊天历史到localStorage
        function saveChatHistory() {
            if (currentSession.length === 0) return;
            
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            
            // 如果当前会话ID存在，更新现有记录；否则创建新记录
            if (currentSessionId) {
                const existingIndex = history.findIndex(item => item.id === currentSessionId);
                if (existingIndex !== -1) {
                    // 更新现有记录
                    history[existingIndex] = {
                        id: currentSessionId,
                        session: currentSession.slice(),
                        time: new Date().toLocaleString(),
                        deep_think: deepThinkMode
                    };
                } else {
                    // 创建新记录
                    history.push({
                        id: currentSessionId,
                        session: currentSession.slice(),
                        time: new Date().toLocaleString(),
                        deep_think: deepThinkMode
                    });
                }
            } else {
                // 创建新记录（使用当前时间作为ID）
                const timestamp = new Date().getTime();
                history.push({
                    id: timestamp,
                    session: currentSession.slice(),
                    time: new Date().toLocaleString(),
                    deep_think: deepThinkMode
                });
            }
            
            localStorage.setItem('chatHistory', JSON.stringify(history));
            renderHistoryList();
        }

        // 加载聊天历史
        function loadChatHistory() {
            renderHistoryList();
        }

        // 渲染历史记录列表
        function renderHistoryList() {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<div style="color:#aaa;text-align:center;padding:1.5em 0;">暂无历史对话</div>';
                return;
            }

            // 倒序显示（最新的在前面）
            history.slice().reverse().forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.setAttribute('data-id', item.id);
                
                // 为当前会话添加高亮标识
                const isCurrentSession = item.id === currentSessionId;
                const currentSessionMark = isCurrentSession ? '<span style="color: #007bff; font-size: 10px; margin-left: 5px;">当前</span>' : '';
                
                // 为深度思考的历史记录添加标记
                const deepThinkMark = item.deep_think ? '<span style="color: #007bff; font-size: 10px; margin-left: 5px;">深度思考</span>' : '';
                
                // 显示第一轮用户消息作为摘要
                let summary = '';
                if (item.session && item.session.length > 0) {
                    const firstUser = item.session.find(msg => msg.role === 'user');
                    if (firstUser) {
                        summary = firstUser.content.substring(0, 30) + (firstUser.content.length > 30 ? '...' : '');
                    } else {
                        // 没有用户消息，显示欢迎语或"新对话"
                        const firstBot = item.session.find(msg => msg.role === 'bot');
                        summary = firstBot ? (firstBot.content.substring(0, 20) + (firstBot.content.length > 20 ? '...' : '')) : '新对话';
                    }
                }
                
                // 为当前会话添加特殊样式
                if (isCurrentSession) {
                    historyItem.style.backgroundColor = '#f8f9fa';
                    historyItem.style.borderLeft = '3px solid #007bff';
                }
                
                historyItem.innerHTML = `
                    <div style="font-weight: 500; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;">
                        <span>${summary}${currentSessionMark}${deepThinkMark}</span>
                        <button class="delete-history-btn" style="background:#e74c3c;color:white;border:none;padding:2px 8px;border-radius:3px;font-size:12px;cursor:pointer;">删除</button>
                    </div>
                    <div style="font-size: 12px; color: #666;">${item.time}</div>
                `;
                
                // 点击加载对话
                historyItem.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-history-btn')) return;
                    loadHistoryItem(item.id);
                    closeSidebarMenu();
                });
                
                // 删除按钮事件
                historyItem.querySelector('.delete-history-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteHistoryItem(item.id);
                });
                
                historyList.appendChild(historyItem);
            });
        }

        // 删除单条历史记录
        function deleteHistoryItem(id) {
            if (!confirm('确定要删除这条对话吗？')) return;
            let history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            history = history.filter(item => item.id !== id);
            localStorage.setItem('chatHistory', JSON.stringify(history));
            // 如果当前聊天区展示的是被删除的对话，则清空聊天区并重置会话状态
            if (currentSessionId === id) {
                currentSession = [];
                currentSessionId = null;
            }
            chatMessages.innerHTML = '';
            appendMessage('bot', '你好！我是代码生成助手。请输入你的代码需求，我会为你生成符合要求的代码~');
            renderHistoryList();
        }

        // 加载指定历史记录（无打字机效果）
        function loadHistoryItem(id) {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            const item = history.find(h => h.id === id);
            if (item && item.session) {
                chatMessages.innerHTML = '';
                item.session.forEach(msg => {
                    appendMessage(msg.role === 'user' ? 'user' : 'bot', msg.content);
                });
                // 恢复当前会话内容和ID，允许继续对话
                currentSession = item.session.slice();
                currentSessionId = item.id;
                // 如果历史记录使用了深度思考模式，自动开启
                if (item.deep_think) {
                    toggleDeepThinkMode(true);
                }
                renderHistoryList(); // 重新渲染高亮
            }
        }

        // 新建对话
        newChatBtn.addEventListener('click', () => {
            saveChatHistory(); // 保存当前会话
            // 新建一个只包含欢迎语的会话
            currentSession = [
                { role: 'bot', content: '你好！我是UPC-Chat。' }
            ];
            currentSessionId = new Date().getTime(); // 新会话ID
            chatMessages.innerHTML = '';
            appendMessage('bot', currentSession[0].content);
            saveChatHistory(); // 立即保存新会话（这样历史栏会出现新对话）
        });

        // 清空所有历史记录
        clearHistoryBtn.addEventListener('click', () => {
            if (confirm('确定要清空所有历史记录吗？')) {
                localStorage.removeItem('chatHistory');
                historyList.innerHTML = '';
            }
        });

        // 调整文本框高度
        messageInput.addEventListener('input', adjustTextareaHeight);

        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            const maxHeight = 100;
            const scrollHeight = messageInput.scrollHeight;
            messageInput.style.height = `${Math.min(scrollHeight, maxHeight)}px`;
        }

        // 页面关闭前保存
        window.addEventListener('beforeunload', () => {
            saveChatHistory();
        });

        // 新增功能按钮事件
        document.getElementById('btn-train').onclick = async function() {
            // 自动向AI发送个性化推荐请求（不显示用户消息）
            const autoMsg = '请根据我的历史对话，推荐一份适合我的代码题目及题目链接，将题目分为入门进阶等难度';
            // 不显示appendMessage，不push到currentSession
            messageInput.value = '';
            adjustTextareaHeight();
            // 调用后端API，模拟为系统消息
            await sendMessageToAI(autoMsg);
        };
        document.getElementById('btn-ide').onclick = function() {
            window.open('https://www.techiedelight.com/compiler/zh/index', '_blank');
        };


        // 每周回顾功能
        document.getElementById('btn-weekly').onclick = function() {
            showWeeklySummaryModal();
        };

        function showWeeklySummaryModal() {
            const today = new Date();
            
            // 获取最近7天的数据
            const dailyStats = {};
            
            // 初始化7天的数据结构
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                const dateStr = date.toLocaleDateString();
                dailyStats[dateStr] = {
                    date: dateStr,
                    problems: 0,
                    topics: [],
                    deepThink: 0
                };
            }
            
            // 从localStorage获取OJ系统数据
            const ojHistory = JSON.parse(localStorage.getItem('ojHistory') || '[]');
            
            // 统计每周OJ系统做题数据
            ojHistory.forEach(item => {
                const sessionDate = new Date(item.timestamp).toLocaleDateString();
                if (dailyStats[sessionDate]) {
                    dailyStats[sessionDate].problems++;
                    if (item.problem && !dailyStats[sessionDate].topics.includes(item.problem)) {
                        dailyStats[sessionDate].topics.push(item.problem);
                    }
                }
            });
            
            // 从聊天历史中获取OJ系统做题数据
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            history.forEach(item => {
                const sessionDate = new Date(item.time).toLocaleDateString();
                if (dailyStats[sessionDate]) {
                    if (item.session) {
                        item.session.forEach(msg => {
                            if (msg.role === 'user' && msg.content.includes('OJ 系统提交代码:')) {
                                dailyStats[sessionDate].problems++;
                                const topic = msg.content.substring(msg.content.indexOf('OJ 系统提交代码:') + 'OJ 系统提交代码:'.length, 30) + (msg.content.length > 30 ? '...' : '');
                                if (!dailyStats[sessionDate].topics.includes(topic)) {
                                    dailyStats[sessionDate].topics.push(topic);
                                }
                            }
                        });
                    }
                    if (item.deep_think) {
                        dailyStats[sessionDate].deepThink++;
                    }
                }
            });
            
            // 生成图表数据
            const chartData = Object.values(dailyStats);
            const totalProblems = chartData.reduce((sum, day) => sum + day.problems, 0);
            const totalDeepThink = chartData.reduce((sum, day) => sum + day.deepThink, 0);
            const activeDays = chartData.filter(day => day.problems > 0).length;
            
            // 创建弹窗
            createModal(chartData, totalProblems, totalDeepThink, activeDays);
        }

        function createModal(chartData, totalProblems, totalDeepThink, activeDays) {
            // 移除已存在的弹窗
            const existingModal = document.getElementById('weekly-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // 检查是否有真实数据
            const hasRealData = totalProblems > 0;
            
            const modal = document.createElement('div');
            modal.id = 'weekly-modal';
            modal.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>📈 本周学习回顾</h2>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${hasRealData ? `
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-number">${totalProblems}</div>
                                        <div class="stat-label">做题总数</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${activeDays}/7</div>
                                        <div class="stat-label">活跃天数</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${(totalProblems / 7).toFixed(1)}</div>
                                        <div class="stat-label">日均做题</div>
                                    </div>
                                </div>
                                <div class="chart-container">
                                    <h3>📊 本周做题趋势</h3>
                                    <div class="chart" id="weekly-chart"></div>
                                </div>
                                <div class="daily-details">
                                    <h3>📅 每日详情</h3>
                                    <div class="daily-list">
                                        ${chartData.map(day => `
                                            <div class="daily-item ${day.problems > 0 ? 'active' : 'inactive'}">
                                                <div class="daily-header">
                                                    <span class="day-name">周${['日', '一', '二', '三', '四', '五', '六'][new Date(day.date).getDay()]}</span>
                                                    <span class="day-date">${day.date}</span>
                                                    <span class="day-problems">${day.problems}题</span>
                                                </div>
                                                ${day.topics.length > 0 ? `
                                                    <div class="daily-topics">
                                                        ${day.topics.map(topic => {
                                                            // 去掉题号，只保留难度和算法类型
                                                            const cleanTopic = topic.replace(/\(题号\d+\)/g, '');
                                                            return `<div class="topic-item">• ${cleanTopic}</div>`;
                                                        }).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="suggestion">
                                    <h3>💡 学习建议</h3>
                                    <p>${getSuggestion(totalProblems, activeDays)}</p>
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 40px 20px;">
                                    <div style="font-size: 48px; margin-bottom: 20px;">📊</div>
                                    <h3 style="color: #666; margin-bottom: 15px;">本周暂无做题记录</h3>
                                    <p style="color: #999; line-height: 1.6;">
                                        本周还没有在代码训练系统中做题的记录。<br>
                                        建议您：<br>
                                        • 点击"代码训练"按钮开始做题<br>
                                        • 在对话框中提交代码进行分析<br>
                                        • 保持每日练习，提升算法能力
                                    </p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // 添加关闭事件
            modal.querySelector('.modal-close').addEventListener('click', () => {
                modal.remove();
            });

            modal.querySelector('.modal-overlay').addEventListener('click', (e) => {
                if (e.target === modal.querySelector('.modal-overlay')) {
                    modal.remove();
                }
            });

            // 只有在有真实数据时才生成图表
            if (hasRealData) {
                generateChart(chartData);
            }
        }

        function generateChart(data) {
            const chartContainer = document.getElementById('weekly-chart');
            const maxProblems = calculateMaxValue(data);
            const chartHeight = 150;
            const chartWidth = 700;
            
            // 创建SVG柱状图
            const svg = `
                <svg width="${chartWidth}" height="${chartHeight + 80}" viewBox="0 0 ${chartWidth} ${chartHeight + 80}">
                    <defs>
                        <linearGradient id="barGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:0.8" />
                        </linearGradient>
                    </defs>
                    
                    <!-- 背景网格 -->
                    ${generateGrid(chartWidth, chartHeight, maxProblems)}
                    
                    <!-- 柱状图 -->
                    ${generateBarChart(data, chartWidth, chartHeight, maxProblems)}
                    
                    <!-- X轴标签 -->
                    ${generateXAxisLabels(data, chartWidth, chartHeight)}
                    
                    <!-- Y轴标签 -->
                    ${generateYAxisLabels(chartHeight, maxProblems)}
                </svg>
            `;
            
            chartContainer.innerHTML = svg;
        }

        function generateGrid(width, height, maxProblems) {
            const gridLines = [];
            const ySteps = 5;
            
            for (let i = 0; i <= ySteps; i++) {
                const y = (height / ySteps) * i;
                const value = Math.round((maxProblems / ySteps) * i);
                
                // 根据数值大小调整网格线透明度
                const opacity = value === 0 ? 0.3 : 0.5;
                const strokeWidth = value === 0 ? 1 : 1;
                
                gridLines.push(`
                    <line x1="0" y1="${y}" x2="${width}" y2="${y}" 
                          stroke="#e0e0e0" stroke-width="${strokeWidth}" opacity="${opacity}"/>
                    <text x="-20" y="${y + 5}" font-size="12" fill="#666" text-anchor="end" font-weight="500">${value}</text>
                `);
            }
            
            return gridLines.join('');
        }

        function generateBarChart(data, width, height, maxProblems) {
            const barWidth = (width / data.length) * 0.6; // 柱子宽度为间距的60%
            const barSpacing = width / data.length;
            
            return data.map((day, index) => {
                const x = barSpacing * index + (barSpacing - barWidth) / 2;
                const barHeight = (day.problems / maxProblems) * height;
                const y = height - barHeight;
                
                // 统一标签位置：显示在柱子上方
                let labelY, labelColor, labelSize;
                
                if (day.problems === 0) {
                    // 0题时显示在底部
                    labelY = height + 15;
                    labelColor = "#999";
                    labelSize = "12";
                } else {
                    // 有做题时统一显示在柱子上方
                    labelY = Math.max(y - 15, 10);
                    labelColor = "#333";
                    labelSize = "14";
                }
                
                // 统一使用蓝色渐变
                let barColor = "url(#barGradient)";
                if (day.problems === 0) {
                    barColor = "#f0f0f0";
                }
                
                return `
                    <!-- 柱子 -->
                    <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" 
                          fill="${barColor}" rx="3" ry="3" opacity="${day.problems === 0 ? '0.5' : '1'}"/>
                    
                    <!-- 数据标签 -->
                    <text x="${x + barWidth/2}" y="${labelY}" font-size="${labelSize}" fill="${labelColor}" 
                          text-anchor="middle" font-weight="bold">${day.problems}</text>
                    
                    <!-- 添加悬停效果提示 -->
                    <title>${day.date}: ${day.problems}题${day.problems === 0 ? ' (无做题记录)' : ''}</title>
                `;
            }).join('');
        }

        function generateXAxisLabels(data, width, height) {
            const barSpacing = width / data.length;
            
            return data.map((day, index) => {
                const x = barSpacing * index + barSpacing / 2;
                const dayName = ['日', '一', '二', '三', '四', '五', '六'][new Date(day.date).getDay()];
                return `<text x="${x}" y="${height + 45}" font-size="14" fill="#666" text-anchor="middle" font-weight="500">周${dayName}</text>`;
            }).join('');
        }

        function calculateMaxValue(data) {
            const actualMax = Math.max(...data.map(d => d.problems));
            
            if (actualMax === 0) {
                return 5; // 如果全是0，显示0-5的刻度
            } else if (actualMax <= 3) {
                return Math.max(actualMax + 1, 5); // 确保至少有5个刻度
            } else if (actualMax <= 10) {
                return Math.ceil(actualMax * 1.2); // 增加20%的空间
            } else {
                return Math.ceil(actualMax * 1.1); // 增加10%的空间
            }
        }

        function generateYAxisLabels(height, maxProblems) {
            const labels = [];
            const ySteps = 5;
            
            for (let i = 0; i <= ySteps; i++) {
                const y = (height / ySteps) * i;
                const value = Math.round((maxProblems / ySteps) * i);
                labels.push(`<text x="-20" y="${y + 5}" font-size="12" fill="#666" text-anchor="end" font-weight="500">${value}</text>`);
            }
            
            return labels.join('');
        }

        function getSuggestion(totalProblems, activeDays) {
            if (totalProblems === 0) {
                return '本周还没有做题记录，建议从简单的算法题开始练习！';
            } else if (activeDays < 3) {
                return '学习频率较低，建议增加每日练习时间！';
            } else if (totalProblems < 10) {
                return '做题数量适中，可以尝试更难的题目！';
            } else {
                return '学习状态很好，继续保持！';
            }
        }



        // 语音输入功能
        const voiceInputBtn = document.getElementById('voice-input-btn');
        if (voiceInputBtn) {
            let recognition;
            let recognizing = false;
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = function() {
                    recognizing = true;
                    voiceInputBtn.classList.add('active');
                    voiceInputBtn.title = '正在聆听...';
                };
                recognition.onend = function() {
                    recognizing = false;
                    voiceInputBtn.classList.remove('active');
                    voiceInputBtn.title = '语音输入';
                };
                recognition.onerror = function(event) {
                    recognizing = false;
                    voiceInputBtn.classList.remove('active');
                    voiceInputBtn.title = '语音输入';
                    alert('语音识别出错: ' + event.error);
                };
                recognition.onresult = function(event) {
                    if (event.results.length > 0) {
                        const transcript = event.results[0][0].transcript;
                        messageInput.value = transcript;
                        adjustTextareaHeight();
                    }
                };

                voiceInputBtn.onclick = function() {
                    if (recognizing) {
                        recognition.stop();
                    } else {
                        recognition.start();
                    }
                };
            } else {
                voiceInputBtn.onclick = function() {
                    alert('当前浏览器不支持语音识别功能');
                };
            }
        }

        // 代码训练按钮功能
        const btnOj = document.getElementById('btn-oj');
        if (btnOj) {
            btnOj.onclick = function() {
                // 在新标签页中打开代码训练系统
                window.open('oj.html', '_blank');
            };
        }

        // 在线IDE按钮功能
        const btnIde = document.getElementById('btn-ide');
        if (btnIde) {
            btnIde.onclick = function() {
                // 在新窗口中打开在线IDE页面
                window.open('https://replit.com/', '_blank');
            };
        }

        // 文件上传功能
        const fileUploadBtn = document.getElementById('file-upload-btn');
        const fileInput = document.getElementById('file-input');
        
        if (fileUploadBtn && fileInput) {
            fileUploadBtn.onclick = function() {
                fileInput.click();
            };
            
            fileInput.onchange = async function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // 检查文件大小（限制为5MB）
                if (file.size > 5 * 1024 * 1024) {
                    alert('文件大小不能超过5MB');
                    return;
                }
                
                try {
                    const fileContent = await readFileAsText(file);
                    const fileName = file.name;
                    const fileExtension = fileName.split('.').pop().toLowerCase();
                    
                    // 构建发送给AI的消息（包含文件内容但不显示）
                    const fileMessage = `我上传了一个文件：${fileName}\n\n文件内容：\n\`\`\`${fileExtension}\n${fileContent}\n\`\`\`\n\n请帮我分析这个文件的内容，并提供相关建议或改进方案。`;
                    
                    // 直接调用AI而不显示在对话框中
                    await sendMessageToAI(fileMessage);
                    
                } catch (error) {
                    alert('文件读取失败: ' + error.message);
                }
                
                // 清空文件输入
                fileInput.value = '';
            };
        }
        
        // 读取文件为文本
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = function(e) {
                    reject(new Error('文件读取失败'));
                };
                reader.readAsText(file);
            });
        }
    </script>
</body>
</html>
